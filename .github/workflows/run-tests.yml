name: Branch CI Testing

on:
 workflow_dispatch:
   inputs:
     branch_name:
       description: 'Branch name'
       required: true
       default: ${{ github.ref_name }}

jobs:
 prepare-testing:
   runs-on: ubuntu-latest
   outputs:
     branch_ref: ${{ github.ref_name }}
     commit_sha: ${{ github.sha }}
   steps:
     - uses: actions/checkout@v3

 trigger-test-app:
   needs: prepare-testing
   runs-on: ubuntu-latest
   steps:
     - name: Trigger test app workflow
       uses: peter-evans/repository-dispatch@v3
       with:
         token: ${{ secrets.DEMO_PAT }}
         repository: cloudcaptainai/helium-demo
         event-type: run-sdk-tests
         client-payload: '{"repo": "${{ github.repository }}", "branch": "${{ needs.prepare-testing.outputs.branch_ref }}", "sha": "${{ needs.prepare-testing.outputs.commit_sha }}"}'

 wait-for-results:
   needs: trigger-test-app
   runs-on: ubuntu-latest
   steps:
     - name: Wait for test results
       run: |
         echo "Tests have been triggered in helium-demo repository"
         echo "Check helium-demo Actions tab for results, or wait for status to be updated on this commit"
