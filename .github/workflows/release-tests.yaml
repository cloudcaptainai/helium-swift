name: Release CI - Test and Create Release

on:
  push:
    branches: [main]
    paths: ['**/BuildConstants.swift']
  workflow_dispatch:

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Extract version
        id: get_version
        run: |
          VERSION=$(grep -o 'version = "[^"]*"' Sources/Helium/HeliumCore/BuildConstants.swift | cut -d'"' -f2)
          echo "Version extracted: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

  run-ui-tests:
    needs: extract-version
    uses: ./.github/workflows/run-tests.yml
    secrets: inherit

  create-release:
    needs: [extract-version, run-ui-tests]
    uses: ./.github/workflows/create-release.yaml
    with:
      version: ${{ needs.extract-version.outputs.version }}
      sha: ${{ github.sha }}
    secrets: inherit
