name: Release CI - Run Tests and Create Release

on:
  push:
    branches: [main]
    paths: ['**/BuildConstants.swift']
  workflow_dispatch:

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Extract version
        id: get_version
        run: |
          VERSION=$(grep -o 'version = "[^"]*"' Sources/Helium/HeliumCore/BuildConstants.swift | cut -d'"' -f2)
          echo "version extracted! $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

  run-ui-tests:
    needs: extract-version
    uses: ./.github/workflows/ui-tests.yml
    secrets: inherit

  trigger-release:
    needs: [extract-version, run-ui-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger create-release workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: tests-passed
          client-payload: '{"version": "${{ needs.extract-version.outputs.version }}", "sha": "${{ github.sha }}"}'

      - name: Release triggered
        run: |
          echo "UI tests passed! Release workflow triggered for version ${{ needs.extract-version.outputs.version }}"
